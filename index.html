<!DOCTYPE html>
<html>
<head>
  <title>Kaleidoscope Drawing</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="p5.min.js"></script>
  <!-- 
    The Tailwind CSS CDN is used here for simplicity in this self-contained single-file example.
    As noted in the console warning, for a production environment, you should use the PostCSS plugin.
  -->
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      margin: 0;
      overflow: hidden;
      background-color: #000;
      font-family: sans-serif;
      color: #fff;
      position: relative;
    }
    canvas {
      display: block;
    }
    .param-table {
      position: absolute;
      top: 20px;
      left: 20px;
      background: rgba(0, 0, 0, 0.3);
      padding: 10px;
      border-radius: 5px;
      font-size: 14px;
      z-index: 10;
      border: 1px solid rgba(255, 255, 255, 0.2);
      transition: opacity 0.5s;
      width: 150px;
    }
    .param-table.hidden {
      opacity: 0;
      pointer-events: none;
    }
    .param-table table {
      border-collapse: collapse;
      width: 100%;
    }
    .param-table th, .param-table td {
      padding: 5px;
      text-align: center;
      border: 1px solid rgba(255, 255, 255, 0.2);
    }
    .param-table th {
      background: rgba(0, 255, 0, 0.1);
      color: #fff;
    }
    .param-table td {
      background: rgba(0, 0, 0, 0.2);
    }
    .controls-container.hidden {
      opacity: 0;
      pointer-events: none;
    }
    .controls-container {
      position: absolute;
      width: 100%;
      height: 100%;
      top: 0;
      left: 0;
      display: flex;
      justify-content: space-between;
      pointer-events: none;
      transition: opacity 0.5s;
    }
    .controls-container > div {
      pointer-events: auto;
    }
    .controls-bottom-left, .controls-bottom-right {
      position: absolute;
      bottom: 20px;
      background: rgba(0, 0, 0, 0.3);
      padding: 10px;
      border-radius: 5px;
      border: 1px solid rgba(255, 255, 255, 0.2);
    }
    .controls-bottom-left {
      left: 20px;
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 5px;
    }
    .controls-bottom-right {
      right: 20px;
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 5px;
    }
    .controls-bottom-left button, .controls-bottom-right button {
        padding: 8px 12px;
        background: transparent;
        color: #fff;
        border: 1px solid rgba(255, 255, 255, 0.5);
        cursor: pointer;
        opacity: 0.8;
        transition: opacity 0.3s;
    }
    .controls-bottom-right button {
      min-width: 150px;
    }
    .controls-bottom-left .full-width-btn {
      grid-column: span 2;
    }

    /* Mobile-specific styles */
    @media (max-width: 768px) {
      .param-table {
        left: 50%;
        transform: translateX(-50%);
        width: 90%;
        max-width: 300px;
      }
      .controls-container {
        flex-direction: column;
        justify-content: flex-end;
      }
      .controls-bottom-left, .controls-bottom-right {
        position: relative;
        left: 0;
        right: 0;
        bottom: 0;
        margin: 10px auto;
        width: 90%;
        max-width: 400px;
        box-sizing: border-box;
      }
      .controls-bottom-right {
        order: -1; /* Place this group above the left one */
      }
      .controls-bottom-left, .controls-bottom-right {
        grid-template-columns: repeat(2, 1fr);
      }
      .controls-bottom-right button {
        min-width: unset;
      }
    }
  </style>
</head>
<body>

<div class="param-table hidden" id="param-table">
  <table>
    <tr><th>Sym</th><td id="sym">6</td></tr>
    <tr><th>Size</th><td id="size">15</td></tr>
    <tr><th>Anim Spd</th><td id="animSpeed">0.030</td></tr>
    <tr><th>Wave Spd</th><td id="waveSpeed">3</td></tr>
    <tr><th>Breath Freq</th><td id="breathingFreq">0.3</td></tr>
    <tr><th>Wave Freq</th><td id="waveSpatialFreq">0.09</td></tr>
    <tr><th>Breath Amp</th><td id="breathingAmp">30</td></tr>
    <tr><th>Color Shift</th><td id="colorShiftSpeed">50</td></tr>
    <tr><th>Pulse Min</th><td id="pulseMin">0.2</td></tr>
    <tr><th>Spacing</th><td id="minDist">1</td></tr>
    <tr><th>Wave Mode</th><td id="waveMode">Both</td></tr>
  </table>
</div>

<div class="controls-container hidden" id="controls-container">
  <div class="controls-bottom-left">
    <button onclick="changeParam('symmetry', -1)">Sym - [U]</button>
    <button onclick="changeParam('symmetry', 1)">Sym + [I]</button>
    <button onclick="changeParam('size', -5)">Size - [D]</button>
    <button onclick="changeParam('size', 5)">Size + [F]</button>
    <button onclick="changeParam('animSpeed', -0.005)">Anim Spd - [T]</button>
    <button onclick="changeParam('animSpeed', 0.005)">Anim Spd + [Y]</button>
    <button onclick="changeParam('waveSpeed', -1)">Wave Spd - [Q]</button>
    <button onclick="changeParam('waveSpeed', 1)">Wave Spd + [W]</button>
    <button onclick="toggleNormalDraw()" class="full-width-btn">Normal Draw - [K]</button>
  </div>
  <div class="controls-bottom-right">
    <button onclick="changeParam('breathingFreq', -0.1)">Breath Freq - [A]</button>
    <button onclick="changeParam('breathingFreq', 0.1)">Breath Freq + [S]</button>
    <button onclick="changeParam('waveSpatialFreq', -0.01)">Wave Freq - [E]</button>
    <button onclick="changeParam('waveSpatialFreq', 0.01)">Wave Freq + [R]</button>
    <button onclick="changeParam('breathingAmp', -10)">Breath Amp - [Z]</button>
    <button onclick="changeParam('breathingAmp', 10)">Breath Amp + [X]</button>
    <button onclick="changeParam('colorShiftSpeed', -10)">Color Shift - [G]</button>
    <button onclick="changeParam('colorShiftSpeed', 10)">Color Shift + [H]</button>
    <button onclick="changeParam('pulseMin', -0.1)">Pulse Min - [V]</button>
    <button onclick="changeParam('pulseMin', 0.1)">Pulse Min + [B]</button>
    <button onclick="changeParam('minDist', -1)">Spacing - [[</button>
    <button onclick="changeParam('minDist', 1)">Spacing + []]</button>
    <button id="waveModeBtn" onclick="changeParam('waveMode', 0)" class="full-width-btn">Wave Mode - Both [M]</button>
    <button id="toggleBreathingBtn" onclick="toggleBreathing()" class="full-width-btn">Breathing - ON [P]</button>
    <button onclick="resetSettings()" class="full-width-btn">Reset - [âŒ«]</button>
    <button onclick="toggleUI()" class="full-width-btn">Hide UI - [`]</button>
  </div>
</div>

<script>
// Prevent right-click context menu unless Ctrl is pressed
document.oncontextmenu = function(event) {
  return event.ctrlKey;
};

// Global variables
let numSymmetry;
let time = 0;
let positions = [];
let baseSize;
let animSpeed;
let waveSpeed;
let breathingFreq;
let waveSpatialFreq;
let breathingAmp;
let colorShiftSpeed;
let pulseMin;
let breathingOn;
let lastSymmetry;
let minDist;
let isUIVisible = false; // Add a state variable for UI visibility
let waveMode; // New global variable for wave direction
let isDrawing = false; // New state to track drawing for touch events

// Default settings
const defaultSettings = {
  numSymmetry: 6,
  waveSpeed: 3,
  breathingFreq: 0.3,
  breathingAmp: 30,
  waveSpatialFreq: 0.09,
  pulseMin: 0.2,
  minDist: 1,
  baseSize: 15,
  animSpeed: 0.03,
  colorShiftSpeed: 50,
  waveMode: 'both'
};

// Auto-hide controls
let hideTimeout;
function showControls() {
  if (!isUIVisible) return;
  const controlsContainer = document.getElementById('controls-container');
  const paramTable = document.getElementById('param-table');
  controlsContainer.classList.remove('hidden');
  paramTable.classList.remove('hidden');
  clearTimeout(hideTimeout);
  hideTimeout = setTimeout(() => {
    controlsContainer.classList.add('hidden');
    paramTable.classList.add('hidden');
  }, 3000);
}
document.addEventListener('mousemove', showControls);
document.addEventListener('keydown', showControls);
document.addEventListener('touchstart', showControls);

function toggleUI() {
  const controlsContainer = document.getElementById('controls-container');
  const paramTable = document.getElementById('param-table');
  isUIVisible = !isUIVisible;
  if (isUIVisible) {
    controlsContainer.classList.remove('hidden');
    paramTable.classList.remove('hidden');
    showControls(); // Start the auto-hide timer
  } else {
    clearTimeout(hideTimeout);
    controlsContainer.classList.add('hidden');
    paramTable.classList.add('hidden');
  }
}

// Load saved drawing
const isSavedDrawing = window.location.hash.startsWith('#positions=');

function setup() {
  // NOTE: p5.js library warnings about deprecated sensors are external and cannot be removed here.
  createCanvas(windowWidth, windowHeight);
  colorMode(HSB, 360, 100, 100, 1);
  background(0);
  resetSettings();
  toggleUI(); // Initial call to show controls

  if (isSavedDrawing) {
    try {
      const positionsString = decodeURIComponent(window.location.hash.substring('#positions='.length));
      positions = JSON.parse(positionsString);
    } catch (e) {
      console.error("Failed to parse drawing data from URL:", e);
      positions = [];
    }
  }
}

function draw() {
  background(0);

  if (mouseIsPressed) {
    handleDraw(mouseX, mouseY, mouseButton);
  }

  // Handle drawing for touch events
  if (isDrawing && touches.length > 0) {
    const touch = touches[0];
    handleDraw(touch.x, touch.y, LEFT); // Treat a single touch as a left-click
  }

  translate(width / 2, height / 2);

  for (let i = 0; i < numSymmetry; i++) {
    push();
    rotate(TWO_PI * i / numSymmetry);
    drawTetrahedronLine();
    pop();

    if (numSymmetry > 1) {
      push();
      rotate(TWO_PI * i / numSymmetry);
      scale(1, -1);
      drawTetrahedronLine();
      pop();
    }
  }

  time += animSpeed;
}

function handleDraw(x, y, button) {
  let currentX = x - width / 2;
  let currentY = y - height / 2;
  if (positions.length === 0 || dist(currentX, currentY, positions[positions.length - 1][0], positions[positions.length - 1][1]) > minDist) {
    positions.push([currentX, currentY, button]);
  }
}

function drawTetrahedronLine() {
  for (let i = 0; i < positions.length; i++) {
    let [x, y, button] = positions[i];
    let pulseValue = getDistancePulse(x, y, time);

    let hue, saturation, brightness, alpha;
    if (button === RIGHT) {
      hue = 0;
      saturation = 0;
      brightness = 70 + 30 * sin(time * 200 * animSpeed + i * 0.4);
      alpha = 0.5 + 0.4 * sin(time * 300 * animSpeed + i * 0.5);
    } else {
      hue = (time * colorShiftSpeed + i * 10) % 360;
      if (hue > 60 && hue < 180) {
        hue = (hue < 120) ? 60 : 180;
      }
      saturation = 100;
      brightness = 70 + 30 * sin(time * 200 * animSpeed + i * 0.4);
      alpha = 0.5 + 0.4 * sin(time * 300 * animSpeed + i * 0.5);
    }

    brightness = brightness * pulseValue;
    let currentSize = baseSize * pulseValue;
    hue = (hue + sin(time * 100 * animSpeed + i * 0.5) * 10) % 360;

    fill(hue, saturation, brightness, alpha);
    noStroke();
    beginShape();
    vertex(x, y - currentSize / sqrt(3));
    vertex(x - currentSize / 2, y + currentSize / (2 * sqrt(3)));
    vertex(x + currentSize / 2, y + currentSize / (2 * sqrt(3)));
    endShape(CLOSE);
  }
}

function getDistancePulse(x, y, time) {
  if (!breathingOn) {
    return 1;
  }
  const d = dist(x, y, 0, 0);
  let direction;
  if (waveMode === 'inward') {
    direction = 1;
  } else if (waveMode === 'outward') {
    direction = -1;
  } else { // waveMode === 'both'
    direction = breathingOn ? sin(time * breathingFreq) : 1;
  }
  const pulse = sin(time * waveSpeed + d * waveSpatialFreq * direction);
  return map(pulse, -1, 1, pulseMin, 1);
}

function toggleBreathing() {
  breathingOn = !breathingOn;
  const button = document.getElementById('toggleBreathingBtn');
  if (button) {
    button.textContent = 'Breathing - ' + (breathingOn ? 'ON' : 'OFF') + ' [P]';
  }
  showControls();
}

function toggleNormalDraw() {
  if (numSymmetry === 1) {
    numSymmetry = lastSymmetry;
  } else {
    lastSymmetry = numSymmetry;
    numSymmetry = 1;
  }
  document.getElementById('sym').textContent = numSymmetry;
  showControls();
}

function saveToTextFile() {
  const positionsStr = JSON.stringify(positions);
  const now = new Date();
  const timestamp = now.toLocaleString();
  const url = window.location.href.split('#')[0] + `#positions=${encodeURIComponent(positionsStr)}`;
  const fileContent = `${timestamp}: ${url}`;
  download(fileContent, 'kaleidoscope_save.txt', 'text/plain');
}

function download(data, filename, type) {
  const blob = new Blob([data], { type });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = filename;
  a.style.display = 'none';
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}

function windowResized() {
  resizeCanvas(windowWidth, windowHeight);
}

function changeParam(param, delta) {
  switch(param) {
    case 'symmetry':
      if (numSymmetry === 1 && delta === 1) {
        numSymmetry = 2;
      } else {
        numSymmetry = Math.max(1, numSymmetry + delta);
      }
      document.getElementById('sym').textContent = numSymmetry;
      break;
    case 'size':
      baseSize = Math.max(5, baseSize + delta);
      document.getElementById('size').textContent = baseSize;
      break;
    case 'animSpeed':
      animSpeed = Math.max(0.001, animSpeed + delta);
      document.getElementById('animSpeed').textContent = animSpeed.toFixed(3);
      break;
    case 'waveSpeed':
      waveSpeed = Math.max(1, waveSpeed + delta);
      document.getElementById('waveSpeed').textContent = waveSpeed.toFixed(0);
      break;
    case 'breathingFreq':
      breathingFreq = Math.max(0.1, breathingFreq + delta);
      document.getElementById('breathingFreq').textContent = breathingFreq.toFixed(1);
      break;
    case 'waveSpatialFreq':
      waveSpatialFreq = Math.max(0.01, waveSpatialFreq + delta);
      document.getElementById('waveSpatialFreq').textContent = waveSpatialFreq.toFixed(2);
      break;
    case 'breathingAmp':
      breathingAmp = Math.max(10, breathingAmp + delta);
      document.getElementById('breathingAmp').textContent = breathingAmp.toFixed(0);
      break;
    case 'colorShiftSpeed':
      colorShiftSpeed = Math.max(10, colorShiftSpeed + delta);
      document.getElementById('colorShiftSpeed').textContent = colorShiftSpeed.toFixed(0);
      break;
    case 'pulseMin':
      pulseMin = Math.min(0.9, Math.max(0.1, pulseMin + delta));
      document.getElementById('pulseMin').textContent = pulseMin.toFixed(1);
      break;
    case 'minDist':
      minDist = Math.max(1, minDist + delta);
      document.getElementById('minDist').textContent = minDist.toFixed(0);
      break;
    case 'waveMode':
      const modes = ['inward', 'outward', 'both'];
      const currentIndex = modes.indexOf(waveMode);
      waveMode = modes[(currentIndex + 1) % modes.length];
      const waveModeBtn = document.getElementById('waveModeBtn');
      if (waveModeBtn) {
        waveModeBtn.textContent = `Wave Mode - ${waveMode.charAt(0).toUpperCase() + waveMode.slice(1)} [M]`;
      }
      document.getElementById('waveMode').textContent = waveMode.charAt(0).toUpperCase() + waveMode.slice(1);
      break;
  }
  showControls();
}

function resetSettings() {
  numSymmetry = defaultSettings.numSymmetry;
  waveSpeed = defaultSettings.waveSpeed;
  breathingFreq = defaultSettings.breathingFreq;
  breathingAmp = defaultSettings.breathingAmp;
  waveSpatialFreq = defaultSettings.waveSpatialFreq;
  pulseMin = defaultSettings.pulseMin;
  minDist = defaultSettings.minDist;
  baseSize = defaultSettings.baseSize;
  animSpeed = defaultSettings.animSpeed;
  colorShiftSpeed = defaultSettings.colorShiftSpeed;
  breathingOn = true;
  waveMode = defaultSettings.waveMode;
  
  const breathingBtn = document.getElementById('toggleBreathingBtn');
  if (breathingBtn) {
    breathingBtn.textContent = 'Breathing - ON [P]';
  }
  const waveModeBtn = document.getElementById('waveModeBtn');
  if (waveModeBtn) {
    waveModeBtn.textContent = `Wave Mode - ${waveMode.charAt(0).toUpperCase() + waveMode.slice(1)} [M]`;
  }
  updateParamTable();
  showControls();
}

function updateParamTable() {
  const paramTable = document.getElementById('param-table');
  if (!paramTable) return;

  document.getElementById('sym').textContent = numSymmetry;
  document.getElementById('size').textContent = baseSize;
  document.getElementById('animSpeed').textContent = animSpeed.toFixed(3);
  document.getElementById('waveSpeed').textContent = waveSpeed.toFixed(0);
  document.getElementById('breathingFreq').textContent = breathingFreq.toFixed(1);
  document.getElementById('waveSpatialFreq').textContent = waveSpatialFreq.toFixed(2);
  document.getElementById('breathingAmp').textContent = breathingAmp.toFixed(0);
  document.getElementById('colorShiftSpeed').textContent = colorShiftSpeed.toFixed(0);
  document.getElementById('pulseMin').textContent = pulseMin.toFixed(1);
  document.getElementById('minDist').textContent = minDist.toFixed(0);
  document.getElementById('waveMode').textContent = waveMode.charAt(0).toUpperCase() + waveMode.slice(1);
}

// ðŸŽ¹ Keyboard shortcuts
document.addEventListener('keydown', (event) => {
  if (event.ctrlKey && event.key.toLowerCase() === 's') {
    event.preventDefault();
    saveToTextFile();
    return;
  }

  if (event.key === 'Delete') {
    positions = [];
    showControls();
    return;
  }

  const key = event.key.toUpperCase();
  switch (key) {
    case 'Q': changeParam('waveSpeed', -1); break;
    case 'W': changeParam('waveSpeed', 1); break;
    case 'A': changeParam('breathingFreq', -0.1); break;
    case 'S': changeParam('breathingFreq', 0.1); break;
    case 'Z': changeParam('breathingAmp', -10); break;
    case 'X': changeParam('breathingAmp', 10); break;
    case 'E': changeParam('waveSpatialFreq', -0.01); break;
    case 'R': changeParam('waveSpatialFreq', 0.01); break;
    case 'D': changeParam('size', -5); break;
    case 'F': changeParam('size', 5); break;
    case 'T': changeParam('animSpeed', -0.005); break;
    case 'Y': changeParam('animSpeed', 0.005); break;
    case 'G': changeParam('colorShiftSpeed', -10); break;
    case 'H': changeParam('colorShiftSpeed', 10); break;
    case 'V': changeParam('pulseMin', -0.1); break;
    case 'B': changeParam('pulseMin', 0.1); break;
    case '[': changeParam('minDist', -1); break;
    case ']': changeParam('minDist', 1); break;
    case 'U': changeParam('symmetry', -1); break;
    case 'I': changeParam('symmetry', 1); break;
    case 'K': toggleNormalDraw(); break;
    case 'P': toggleBreathing(); break;
    case 'M': changeParam('waveMode', 0); break;
  }
  
  // Backtick key to toggle UI
  if (event.key === '`') {
    toggleUI();
  }

  if (event.key === 'Backspace') {
    resetSettings();
  }
});

// Touch event handlers for mobile drawing
function touchStarted() {
  isDrawing = true;
  return false; // Prevents default touch behavior (e.g., scrolling)
}

function touchMoved() {
  // `draw()` loop handles adding positions when `isDrawing` is true
  return false; // Prevents default touch behavior
}

function touchEnded() {
  isDrawing = false;
  return false; // Prevents default touch behavior
}
</script>
</body>
</html>
